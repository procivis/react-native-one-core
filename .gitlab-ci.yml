image: node:18.16.0-alpine

variables:
  NODE_OPTIONS: --max_old_space_size=1536
  DOCKER_DRIVER: overlay2
  YARN_CACHE_FOLDER: "./.yarn/cache"
  YARN_ENABLE_GLOBAL_CACHE: "false"


stages:
  - prepare
  - build
  - publish


.only_tag:
  rules:
    - if: $CI_COMMIT_TAG

.only_manual_tag:
  rules:
    - if: $CI_COMMIT_TAG
      when: manual

.yarn-cache: &yarn-cache
    key:
      files:
        - yarn.lock
    paths:
      - node_modules/
      - ${YARN_CACHE_FOLDER}
    policy: pull

.modules_setup:
  cache:
    <<: *yarn-cache
  before_script:
    - apk add --update --no-cache --virtual .build-deps alpine-sdk libc6-compat gcompat
    - yarn global add node-gyp @mapbox/node-pre-gyp --network-concurrency 1
    - yarn install --frozen-lockfile --network-concurrency 1


build_deps:
  stage: prepare
  extends:
    - .modules_setup
  script:
    - ''
  cache:
    policy: pull-push

build:
  stage: build
  extends: .modules_setup
  script:
    - yarn compile


publish:npm:private:
  stage: publish
  needs: [build_deps]
  script:
    - npm config set @procivis:registry https://${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/
    - npm config set //${CI_SERVER_HOST}/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken ${CI_JOB_TOKEN}
    - npm publish --verbose --access restricted --tag stable
  extends:
    - .modules_setup
    - .only_tag

publish:npm:public:
  stage: publish
  needs: [build_deps]
  script:
    - npm config set //registry.npmjs.org/:_authToken ${NPMJS_TOKEN}
    - npm publish --verbose --access public 
  extends:
    - .modules_setup
    - .only_manual_tag
